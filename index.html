<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>T√†i ƒê·ªó_Qu·∫£n l√Ω Th·ª≠a ƒë·∫•t_2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary-white: #ffffff;
      --bg-light: #f8f9fa;
      --border-color: #dee2e6;
      --text-main: #343a40;
      --accent-orange: #fd7e14;
      --accent-blue: #0d6efd;
    }

    body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-light); overflow: hidden; color: var(--text-main); }
    #map { height: 100vh; width: 100%; z-index: 1; background: #eee; }
    
    /* --- GIAO DI·ªÜN TR·∫ÆNG HI·ªÜN ƒê·∫†I --- */
    #top-panel {
      position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
      background: var(--primary-white); padding: 12px 15px;
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      border-radius: 8px; border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .input-group { display: flex; align-items: center; gap: 6px; }
    
    input[type="number"], input[type="text"], input[type="file"] { 
      padding: 8px 12px; border: 1px solid var(--border-color); 
      border-radius: 6px; font-size: 13px; outline: none;
      transition: border-color 0.2s;
    }
    input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(13,110,253,0.1); }
    
    #soto, #sothua { width: 50px; }
    #tenchu { width: 120px; }
    #file-input { max-width: 130px; background: #f1f3f5; cursor: pointer; }

    .checkbox-group { display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .checkbox-group input { width: 17px; height: 17px; cursor: pointer; }

    button {
      padding: 9px 14px; border: none; border-radius: 6px; 
      cursor: pointer; font-weight: 600; font-size: 12px;
      display: flex; align-items: center; gap: 5px; transition: 0.3s;
    }
    .btn-search { background: var(--accent-orange); color: white; }
    .btn-search:hover { background: #e86d05; }
    .btn-clear { background: #e9ecef; color: #495057; }
    .btn-clear:hover { background: #dee2e6; }
    .btn-locate { background: var(--accent-blue); color: white; }
    .btn-locate:hover { background: #0b5ed7; }
    .btn-direction { background: #198754; color: white; }

    #info-bar {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
      background: var(--primary-white); padding: 12px 20px; display: none;
      overflow-x: auto; border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
    }

    .info-container { display: flex; gap: 25px; align-items: center; min-width: max-content; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-size: 11px; color: #6c757d; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
    .info-value { font-size: 15px; color: var(--text-main); font-weight: 700; white-space: nowrap; }

    /* NH√ÉN C·∫†NH XOAY */
    .edge-label-container { background: transparent; border: none; }
    .edge-label-inner {
      background: var(--primary-white); border: 1.5px solid #dc3545; 
      border-radius: 4px; padding: 2px 5px; font-size: 11px; font-weight: 800; 
      color: #dc3545; white-space: nowrap; box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
      display: inline-flex; align-items: center; justify-content: center;
    }

    .gps-fixed { animation: pulse 2s infinite; border: 2px solid white; border-radius: 50%; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(13, 110, 253, 0); }
      100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
    }

    #loading-status {
      position: fixed; top: 85px; left: 50%; transform: translateX(-50%);
      background: var(--text-main); color: white; padding: 10px 20px;
      border-radius: 30px; font-size: 13px; display: none; z-index: 2000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    @media (max-width: 600px) {
      #top-panel { top: 5px; left: 5px; right: 5px; padding: 8px; gap: 6px; }
      #tenchu { width: 85px; }
      button { padding: 8px 10px; font-size: 11px; }
      #file-input { max-width: 100px; }
    }
  </style>
</head>
<body>

<div id="loading-status">üõ∞Ô∏è ƒêang ƒë·ªìng b·ªô v·ªã tr√≠ v·ªá tinh...</div>

<div id="top-panel">
  <input type="file" id="file-input" accept=".geojson">
  <div class="input-group">
    <input type="number" id="soto" placeholder="T·ªù">
    <input type="number" id="sothua" placeholder="Th·ª≠a">
    <input type="text" id="tenchu" placeholder="T√™n ch·ªß">
  </div>
  <label class="checkbox-group">
    <input type="checkbox" id="chk-edges" checked onchange="toggleEdges()"> Hi·ªán C·∫°nh
  </label>
  <button class="btn-search" onclick="searchParcel()">üîç T√åM</button>
  <button class="btn-clear" onclick="clearSearch()">‚úñ</button>
  <button class="btn-locate" onclick="locateUser()">üìç V·ªä TR√ç</button>
</div>

<div id="info-bar">
  <div class="info-container">
    <div id="info-content" style="display: flex; gap: 20px;"></div>
    <div id="direction-btn-container"></div>
  </div>
</div>

<div id="map"></div>

<script>
  const map = L.map('map', { maxZoom: 22, zoomControl: false }).setView([10.8, 106.7], 15);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3']
  }).addTo(map);

  let dataLayer = null, highlightLayer = null, geojsonData = null, userMarker = null, currentSelectedFeature = null;
  let edgeLabelsLayer = L.layerGroup().addTo(map);

  const fieldMapping = { 
    "SHBANDO": "T·ªù", "SHTHUA": "Th·ª≠a", "DIENTICH": "Di·ªán t√≠ch (m¬≤)", 
    "KHLOAIDAT": "Lo·∫°i ƒë·∫•t", "TENCHU": "T√™n ch·ªß" 
  };

  document.getElementById('file-input').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function() {
      try {
        geojsonData = JSON.parse(reader.result);
        renderBoundaries(geojsonData);
      } catch(err) { alert("L·ªói ƒë·ªçc file GeoJSON!"); }
    };
    reader.readAsText(e.target.files[0]);
  };

  function renderBoundaries(data) {
    if (dataLayer) map.removeLayer(dataLayer);
    dataLayer = L.geoJSON(data, {
      style: { color: "#ffeb3b", weight: 1.5, fillOpacity: 0.1 },
      onEachFeature: function(feature, layer) {
        layer.on('click', function(e) { processSelection(feature, layer); L.DomEvent.stopPropagation(e); });
      }
    }).addTo(map);
    map.fitBounds(dataLayer.getBounds());
  }

  function searchParcel() {
    const s = document.getElementById('soto').value.trim();
    const t = document.getElementById('sothua').value.trim();
    const n = document.getElementById('tenchu').value.trim().toLowerCase();
    if (!geojsonData) return alert("Vui l√≤ng n·∫°p file GeoJSON!");

    let foundFeature = null, foundLayer = null;
    dataLayer.eachLayer(function(layer) {
      const p = layer.feature.properties;
      const matchPT = (s && t) ? (String(p.SHBANDO) == s && String(p.SHTHUA) == t) : false;
      const matchN = n ? (String(p.TENCHU || "").toLowerCase().includes(n)) : false;
      if (matchPT || matchN) { foundFeature = layer.feature; foundLayer = layer; }
    });

    if (foundFeature) processSelection(foundFeature, foundLayer);
    else alert("Kh√¥ng t√¨m th·∫•y th·ª≠a ƒë·∫•t y√™u c·∫ßu!");
  }

  function processSelection(feature, layer) {
    currentSelectedFeature = feature;
    highlightParcel([feature]);
    const center = layer.getBounds().getCenter();
    showInfoHorizontal(feature.properties, center.lat, center.lng);
    toggleEdges();
    map.fitBounds(layer.getBounds(), { padding: [100, 100] });
  }

  function toggleEdges() {
    if (!currentSelectedFeature) return;
    edgeLabelsLayer.clearLayers();
    if (document.getElementById('chk-edges').checked) {
      let coords = (currentSelectedFeature.geometry.type === "Polygon") ? 
                   currentSelectedFeature.geometry.coordinates[0] : 
                   currentSelectedFeature.geometry.coordinates[0][0];
      
      for (let i = 0; i < coords.length - 1; i++) {
        let p1 = L.latLng(coords[i][1], coords[i][0]);
        let p2 = L.latLng(coords[i+1][1], coords[i+1][0]);
        let dist = p1.distanceTo(p2);
        if (dist > 0.5) {
          let mid = [(p1.lat + p2.lat)/2, (p1.lng + p2.lng)/2];
          let angle = Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
          let rotation = -angle;
          if (rotation > 90) rotation -= 180;
          if (rotation < -90) rotation += 180;

          let labelHtml = `<div class="edge-label-inner" style="transform: rotate(${rotation}deg);">${dist.toFixed(1)}m</div>`;
          L.marker(mid, { 
            icon: L.divIcon({ className: 'edge-label-container', html: labelHtml, iconSize: [40, 20], iconAnchor: [20, 10] }), 
            interactive: false 
          }).addTo(edgeLabelsLayer);
        }
      }
    }
  }

  function highlightParcel(features) {
    if (highlightLayer) map.removeLayer(highlightLayer);
    highlightLayer = L.geoJSON({type: "FeatureCollection", features: features}, {
      style: { color: "#dc3545", weight: 4, fillColor: "#0d6efd", fillOpacity: 0.2 }
    }).addTo(map);
  }

  function showInfoHorizontal(props, lat, lng) {
    const bar = document.getElementById('info-bar'), content = document.getElementById('info-content'), btnContainer = document.getElementById('direction-btn-container');
    bar.style.display = 'block';
    let html = "";
    Object.keys(props).forEach(key => {
        let label = fieldMapping[key] || key;
        let val = props[key];
        if (key === "SHBANDO" || key === "SHTHUA") val = Math.floor(Number(val));
        else if (key === "DIENTICH") val = Number(val).toFixed(1);
        else if (typeof val === 'number') val = Number.isInteger(val) ? val : val.toFixed(1);
        html += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val || "-"}</span></div>`;
    });
    content.innerHTML = html;
    btnContainer.innerHTML = `<button class="btn-direction" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">üöó CH·ªà ƒê∆Ø·ªúNG</button>`;
  }

  function locateUser() {
    if (!navigator.geolocation) return alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS!");
    document.getElementById('loading-status').style.display = 'block';
    map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true, timeout: 15000 });
  }

  map.on('locationfound', function(e) {
    document.getElementById('loading-status').style.display = 'none';
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.layerGroup([
      L.circle(e.latlng, { radius: e.accuracy / 2, color: '#0d6efd', fillOpacity: 0.1 }),
      L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#0d6efd', fillOpacity: 1, weight: 3, className: 'gps-fixed' })
    ]).addTo(map);
  });

  map.on('locationerror', function(e) {
    document.getElementById('loading-status').style.display = 'none';
    if (e.code === 1) alert("L·ªói: Quy·ªÅn v·ªã tr√≠ b·ªã t·ª´ ch·ªëi. H√£y b·∫≠t trong c√†i ƒë·∫∑t tr√¨nh duy·ªát!");
    else map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: false, timeout: 5000 });
  });

  function clearSearch() {
    document.getElementById('soto').value = ''; document.getElementById('sothua').value = ''; document.getElementById('tenchu').value = '';
    currentSelectedFeature = null; if (highlightLayer) map.removeLayer(highlightLayer);
    edgeLabelsLayer.clearLayers(); document.getElementById('info-bar').style.display = 'none';
  }
</script>
</body>
</html>
