<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>T√†i ƒê·ªó_Map_2025_7P_Full</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
  <style>
    :root {
      --primary-white: #ffffff;
      --bg-light: #f8f9fa;
      --border-color: #dee2e6;
      --text-main: #343a40;
      --accent-orange: #fd7e14;
      --accent-blue: #0d6efd;
      --accent-green: #198754;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      overflow: hidden;
      color: var(--text-main);
    }

    #map {
      height: 100vh;
      width: 100%;
      z-index: 1;
      background: #eee;
    }

    #top-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1000;
      background: var(--primary-white);
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"],
    input[type="text"],
    input[type="file"],
    select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    #input-vn2000,
    #input-wgs84 {
      width: 140px;
    }

    .file-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .file-box label {
      font-size: 10px;
      font-weight: bold;
      color: #666;
    }

    #soto,
    #sothua {
      width: 50px;
    }

    #tenchu {
      width: 100px;
    }

    .layer-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 10px;
      border-left: 1px solid #ddd;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    button {
      padding: 9px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
    }

    .btn-search {
      background: var(--accent-orange);
      color: white;
    }

    .btn-locate {
      background: var(--accent-blue);
      color: white;
    }

    .btn-clear {
      background: #e9ecef;
      color: #495057;
    }

    .btn-direction {
      background: var(--accent-green);
      color: white;
    }

    .btn-export {
      background: #6f42c1;
      color: white;
    }

    #info-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--primary-white);
      padding: 12px 20px;
      display: none;
      overflow-x: auto;
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.05);
    }

    .info-container {
      display: flex;
      gap: 25px;
      align-items: center;
      min-width: max-content;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 11px;
      color: #6c757d;
      font-weight: 700;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 15px;
      color: var(--text-main);
      font-weight: 700;
    }

    .edge-label-inner {
      background: var(--primary-white);
      border: 1.5px solid #dc3545;
      border-radius: 4px;
      padding: 2px 5px;
      font-size: 11px;
      font-weight: 800;
      color: #dc3545;
      white-space: nowrap;
    }

    #loading-status {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-main);
      color: white;
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 13px;
      display: none;
      z-index: 2000;
    }

    @media (max-width: 768px) {
      #top-panel {
        gap: 8px;
      }

      .layer-controls {
        border-left: none;
        border-top: 1px solid #ddd;
        padding-top: 5px;
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <div id="loading-status">üõ∞Ô∏è ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>

  <div id="top-panel">
    <div class="file-box">
      <label>ƒê·ªäA CH√çNH</label>
      <input type="file" id="file-dc" accept=".geojson">
    </div>
    <div class="file-box">
      <label>QUY HO·∫†CH</label>
      <input type="file" id="file-qh" accept=".geojson">
    </div>

    <div class="file-box">
      <label>T·ªàNH/TP (KTT)</label>
      <select id="sel-province"></select>
    </div>

    <div class="input-group">
      <input type="number" id="soto" placeholder="T·ªù">
      <input type="number" id="sothua" placeholder="Th·ª≠a">
      <input type="text" id="tenchu" placeholder="T√™n ch·ªß">
    </div>

    <div class="input-group">
      <input type="text" id="input-vn2000" placeholder="VN2000: Y, X (m)">
      <button class="btn-search" onclick="searchVN2000()">üîç VN</button>
    </div>

    <div class="input-group">
      <input type="text" id="input-wgs84" placeholder="WGS84: Lat, Lng">
      <button class="btn-search" onclick="searchWGS84()">üîç WGS</button>
    </div>

    <div class="layer-controls">
      <label class="checkbox-group"><input type="checkbox" id="chk-dc" checked onchange="toggleLayer('dc')"> Hi·ªán
        ƒêC</label>
      <label class="checkbox-group"><input type="checkbox" id="chk-qh" checked onchange="toggleLayer('qh')"> Hi·ªán
        QH</label>
      <label class="checkbox-group"><input type="checkbox" id="chk-edges" checked onchange="updateEdges()"> Hi·ªán
        C·∫°nh</label>
    </div>

    <button class="btn-search" onclick="searchParcel()">üîç T√åM</button>
    <button class="btn-clear" onclick="clearSearch()">‚úñ</button>
    <button class="btn-locate" onclick="locateUser()">üìç V·ªä TR√ç</button>
  </div>

  <div id="info-bar">
    <div class="info-container">
      <div id="info-content" style="display: flex; gap: 20px;"></div>
      <div id="direction-btn-container" style="display: flex; gap: 10px;"></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map', { maxZoom: 22, zoomControl: false }).setView([12.667, 108.038], 15);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
      maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(map);

    let dcLayer = null, qhLayer = null, highlightLayer = null;
    let dcData = null, currentSelectedFeature = null;
    let edgeLabelsLayer = L.layerGroup().addTo(map);
    let currentKTT = 108.5;

    const fieldMapping = {
      "SHBANDO": "T·ªù", "SHTHUA": "Th·ª≠a", "DIENTICH": "Di·ªán t√≠ch (m¬≤)",
      "KHLOAIDAT": "Lo·∫°i ƒë·∫•t", "TENCHU": "T√™n ch·ªß"
    };

    // 1. DANH S√ÅCH 63 T·ªàNH TH√ÄNH (KTT VN2000)
    const provinces = [
      { name: "An Giang", ktt: 104.75 }, { name: "B√† R·ªãa - V≈©ng T√†u", ktt: 107.75 }, { name: "B·∫°c Li√™u", ktt: 105.00 },
      { name: "B·∫Øc K·∫°n", ktt: 106.50 }, { name: "B·∫Øc Giang", ktt: 107.00 }, { name: "B·∫Øc Ninh", ktt: 105.50 },
      { name: "B·∫øn Tre", ktt: 105.75 }, { name: "B√¨nh D∆∞∆°ng", ktt: 105.75 }, { name: "B√¨nh ƒê·ªãnh", ktt: 108.25 },
      { name: "B√¨nh Ph∆∞·ªõc", ktt: 106.25 }, { name: "B√¨nh Thu·∫≠n", ktt: 108.50 }, { name: "C√† Mau", ktt: 104.50 },
      { name: "Cao B·∫±ng", ktt: 105.75 }, { name: "C·∫ßn Th∆°", ktt: 105.00 }, { name: "ƒê√† N·∫µng", ktt: 107.75 },
      { name: "ƒê·∫Øk L·∫Øk", ktt: 108.50 }, { name: "ƒê·∫Øk N√¥ng", ktt: 108.50 }, { name: "ƒêi·ªán Bi√™n", ktt: 103.00 },
      { name: "ƒê·ªìng Nai", ktt: 107.75 }, { name: "ƒê·ªìng Th√°p", ktt: 105.00 }, { name: "Gia Lai", ktt: 108.50 },
      { name: "H√† Giang", ktt: 105.50 }, { name: "H√† Nam", ktt: 105.00 }, { name: "H√† N·ªôi", ktt: 105.00 },
      { name: "H√† Tƒ©nh", ktt: 105.50 }, { name: "H·∫£i D∆∞∆°ng", ktt: 105.50 }, { name: "H·∫£i Ph√≤ng", ktt: 105.75 },
      { name: "H·∫≠u Giang", ktt: 105.00 }, { name: "H√≤a B√¨nh", ktt: 106.00 }, { name: "TP. H·ªì Ch√≠ Minh", ktt: 105.75 },
      { name: "H∆∞ng Y√™n", ktt: 105.50 }, { name: "Kh√°nh H√≤a", ktt: 108.25 }, { name: "Ki√™n Giang", ktt: 104.50 },
      { name: "Kon Tum", ktt: 107.50 }, { name: "Lai Ch√¢u", ktt: 103.00 }, { name: "L√¢m ƒê·ªìng", ktt: 107.75 },
      { name: "L·∫°ng S∆°n", ktt: 107.25 }, { name: "L√†o Cai", ktt: 104.75 }, { name: "Long An", ktt: 105.75 },
      { name: "Nam ƒê·ªãnh", ktt: 105.50 }, { name: "Ngh·ªá An", ktt: 104.75 }, { name: "Ninh B√¨nh", ktt: 105.00 },
      { name: "Ninh Thu·∫≠n", ktt: 108.25 }, { name: "Ph√∫ Th·ªç", ktt: 104.75 }, { name: "Ph√∫ Y√™n", ktt: 108.50 },
      { name: "Qu·∫£ng B√¨nh", ktt: 106.00 }, { name: "Qu·∫£ng Nam", ktt: 107.75 }, { name: "Qu·∫£ng Ng√£i", ktt: 108.00 },
      { name: "Qu·∫£ng Ninh", ktt: 107.75 }, { name: "Qu·∫£ng Tr·ªã", ktt: 106.25 }, { name: "S√≥c TrƒÉng", ktt: 105.50 },
      { name: "S∆°n La", ktt: 104.00 }, { name: "T√¢y Ninh", ktt: 105.50 }, { name: "Th√°i B√¨nh", ktt: 105.50 },
      { name: "Th√°i Nguy√™n", ktt: 106.50 }, { name: "Thanh H√≥a", ktt: 105.00 }, { name: "Th·ª´a Thi√™n Hu·∫ø", ktt: 107.00 },
      { name: "Ti·ªÅn Giang", ktt: 105.75 }, { name: "Tr√† Vinh", ktt: 105.50 }, { name: "Tuy√™n Quang", ktt: 106.00 },
      { name: "Vƒ©nh Long", ktt: 105.50 }, { name: "Vƒ©nh Ph√∫c", ktt: 105.00 }, { name: "Y√™n B√°i", ktt: 104.75 }
    ].sort((a, b) => a.name.localeCompare(b.name));

    // Kh·ªüi t·∫°o Select Province
    const selProv = document.getElementById('sel-province');
    provinces.forEach(p => {
      let opt = new Option(`${p.name} (${p.ktt})`, p.ktt);
      if (p.name === "ƒê·∫Øk L·∫Øk") opt.selected = true;
      selProv.add(opt);
    });

    selProv.onchange = function () { updateVN2000(parseFloat(this.value)); };

    // 2. C·∫¨P NH·∫¨T H√ÄM VN2000 V·ªöI 7 THAM S·ªê V√Ä GRS80
    function updateVN2000(ktt) {
      currentKTT = ktt;
      const def = `+proj=tmerc +lat_0=0 +lon_0=${ktt} +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=-191.90441429,-39.30318279,-111.45032835,0.00928836,-0.01975479,0.00427372,0.252906278 +units=m +no_defs`;
      proj4.defs("VN2000_Current", def);
    }
    updateVN2000(currentKTT);

    // X·ª≠ l√Ω file
    document.getElementById('file-dc').onchange = e => loadFile(e.target.files[0], 'dc');
    document.getElementById('file-qh').onchange = e => loadFile(e.target.files[0], 'qh');

    function loadFile(file, type) {
      if (!file) return;
      const reader = new FileReader();
      document.getElementById('loading-status').style.display = 'block';
      reader.onload = function () {
        try {
          const json = JSON.parse(reader.result);
          type === 'dc' ? (dcData = json, renderDC(json)) : renderQH(json);
        } catch (err) { alert("L·ªói GeoJSON!"); }
        document.getElementById('loading-status').style.display = 'none';
      };
      reader.readAsText(file);
    }

    function renderDC(data) {
      if (dcLayer) map.removeLayer(dcLayer);
      dcLayer = L.geoJSON(data, {
        style: { color: "#ffeb3b", weight: 1.5, fillOpacity: 0.1 },
        onEachFeature: (f, l) => l.on('click', e => { processSelection(f, l); L.DomEvent.stopPropagation(e); })
      }).addTo(map);
      map.fitBounds(dcLayer.getBounds());
    }

    function renderQH(data) {
      if (qhLayer) map.removeLayer(qhLayer);
      qhLayer = L.geoJSON(data, {
        style: f => ({ color: "#333", weight: 0.5, fillColor: f.properties.fill || "#000", fillOpacity: f.properties["fill-opacity"] || 0.5 }),
        interactive: false
      }).addTo(map);
      if (qhLayer.getBounds().isValid()) map.fitBounds(qhLayer.getBounds());
    }

    function toggleLayer(type) {
      if (type === 'dc' && dcLayer) document.getElementById('chk-dc').checked ? map.addLayer(dcLayer) : map.removeLayer(dcLayer);
      if (type === 'qh' && qhLayer) document.getElementById('chk-qh').checked ? map.addLayer(qhLayer) : map.removeLayer(qhLayer);
    }

    function processSelection(feature, layer) {
      currentSelectedFeature = feature;
      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, { style: { color: "#dc3545", weight: 4, fillColor: "#0d6efd", fillOpacity: 0.2 } }).addTo(map);
      const center = layer.getBounds().getCenter();
      showInfoHorizontal(feature.properties, center.lat, center.lng);
      updateEdges();
      map.fitBounds(layer.getBounds(), { padding: [100, 100] });
    }

    function updateEdges() {
      edgeLabelsLayer.clearLayers();
      if (!currentSelectedFeature || !document.getElementById('chk-edges').checked) return;
      let coords = (currentSelectedFeature.geometry.type === "Polygon") ? currentSelectedFeature.geometry.coordinates[0] : currentSelectedFeature.geometry.coordinates[0][0];
      for (let i = 0; i < coords.length - 1; i++) {
        let p1 = L.latLng(coords[i][1], coords[i][0]), p2 = L.latLng(coords[i + 1][1], coords[i + 1][0]);
        let dist = p1.distanceTo(p2);
        if (dist > 0.3) {
          let mid = [(p1.lat + p2.lat) / 2, (p1.lng + p2.lng) / 2];
          let rotation = -Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
          if (rotation > 90) rotation -= 180; if (rotation < -90) rotation += 180;
          L.marker(mid, {
            icon: L.divIcon({ className: 'edge-label-container', html: `<div class="edge-label-inner" style="transform: rotate(${rotation}deg);">${dist.toFixed(2)}m</div>`, iconSize: [40, 20] }), interactive: false
          }).addTo(edgeLabelsLayer);
        }
      }
    }

    function showInfoHorizontal(props, lat, lng) {
      const bar = document.getElementById('info-bar'), content = document.getElementById('info-content'), btnContainer = document.getElementById('direction-btn-container');
      bar.style.display = 'block';
      let html = "";
      Object.keys(props).forEach(key => {
        let label = fieldMapping[key] || key;
        let val = props[key];
        if (key === "SHBANDO" || key === "SHTHUA") val = Math.floor(Number(val));
        else if (key === "DIENTICH") val = Number(val).toFixed(1);
        html += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val || "-"}</span></div>`;
      });
      content.innerHTML = html;
      btnContainer.innerHTML = `<button class="btn-direction" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">üöó CH·ªà ƒê∆Ø·ªúNG</button>
                                <button class="btn-export" onclick="exportCoords()">üì• XU·∫§T T·ªåA ƒê·ªò</button>`;
    }

    // 3. HI·ªÇN TH·ªä T·ªåA ƒê·ªò KHI CLICK L√ÄM TR√íN 3 S·ªê
    map.on('click', function (e) {
      const vn2000 = proj4(proj4.defs('EPSG:4326'), proj4.defs('VN2000_Current'), [e.latlng.lng, e.latlng.lat]);
      L.popup().setLatLng(e.latlng).setContent(`
        <div style="text-align:center; font-size:13px;">
          <strong style="color:#0d6efd">üìç T·ªåA ƒê·ªò V·ªä TR√ç</strong><br>
          <div style="margin-top:5px; text-align:left;">
            <b>WGS84:</b> ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}<br>
            <b>VN2000 (KTT ${currentKTT}):</b><br>X: ${vn2000[1].toFixed(3)} | Y: ${vn2000[0].toFixed(3)}
          </div>
        </div>
      `).openOn(map);
    });

    // 4. XU·∫§T T·ªåA ƒê·ªò L√ÄM TR√íN 3 S·ªê TH·∫¨P PH√ÇN
    function exportCoords() {
      if (!currentSelectedFeature) return;
      let coords = (currentSelectedFeature.geometry.type === "Polygon") ? currentSelectedFeature.geometry.coordinates[0] : currentSelectedFeature.geometry.coordinates[0][0];
      let pts = coords.slice(0, -1).reverse(); // ƒê·∫£o chi·ªÅu ƒë·ªÉ xu·∫•t CW (chi·ªÅu kim ƒë·ªìng h·ªì)

      let vnPts = pts.map(p => {
        let xy = proj4(proj4.defs('EPSG:4326'), proj4.defs('VN2000_Current'), [p[0], p[1]]);
        return { x: xy[1], y: xy[0] };
      });

      let maxIdx = 0;
      vnPts.forEach((p, i) => { if (p.x > vnPts[maxIdx].x) maxIdx = i; });
      let ordered = [...vnPts.slice(maxIdx), ...vnPts.slice(0, maxIdx)];

      let content = "STT\tX(m)\tY(m)\tZ(m)\n";
      ordered.forEach((pt, idx) => {
        content += `${idx + 1}\t${pt.x.toFixed(3)}\t${pt.y.toFixed(3)}\t0.000\n`;
      });

      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `ToaDo_To_${currentSelectedFeature.properties.SHBANDO}_Thua_${currentSelectedFeature.properties.SHTHUA}.txt`;
      link.click();
    }

    function searchParcel() {
      const s = document.getElementById('soto').value.trim(), t = document.getElementById('sothua').value.trim(), n = document.getElementById('tenchu').value.trim().toLowerCase();
      if (!dcLayer) return alert("Vui l√≤ng n·∫°p file ƒê·ªãa ch√≠nh!");
      let found = null;
      dcLayer.eachLayer(l => {
        const p = l.feature.properties;
        if ((s && t && p.SHBANDO == s && p.SHTHUA == t) || (n && String(p.TENCHU || "").toLowerCase().includes(n))) found = l;
      });
      found ? processSelection(found.feature, found) : alert("Kh√¥ng t√¨m th·∫•y!");
    }

    function clearSearch() {
      ['soto', 'sothua', 'tenchu', 'input-vn2000', 'input-wgs84'].forEach(id => document.getElementById(id).value = '');
      if (highlightLayer) map.removeLayer(highlightLayer);
      if (searchMarkerFn) map.removeLayer(searchMarkerFn);
      edgeLabelsLayer.clearLayers();
      document.getElementById('info-bar').style.display = 'none';
      currentSelectedFeature = null;
    }

    let searchMarkerFn = null;
    function createSearchMarker(latlng, popupContent) {
      if (searchMarkerFn) map.removeLayer(searchMarkerFn);
      searchMarkerFn = L.marker(latlng).addTo(map)
        .bindPopup(popupContent).openPopup();
      return searchMarkerFn;
    }

    function searchVN2000() {
      const val = document.getElementById('input-vn2000').value.trim();
      if (!val) return alert("Nh·∫≠p t·ªça ƒë·ªô VN2000: Y X (ho·∫∑c Y, X)!");
      // Ch·∫•p nh·∫≠n c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c kho·∫£ng tr·∫Øng
      // Format ƒë√∫ng user y√™u c·∫ßu: Y (6 s·ªë) tr∆∞·ªõc, X (7 s·ªë) sau? Hay ng∆∞·ª£c l·∫°i? 
      // Input placeholder: Y, X (m) -> T·ª©c Easting, Northing
      // Proj4 args: [Easting, Northing]

      let parts = val.split(/[,;\s]+/).map(Number).filter(n => !isNaN(n));
      if (parts.length < 2) return alert("C·∫ßn nh·∫≠p ƒë·ªß X v√† Y!");

      // Gi·∫£ s·ª≠ user nh·∫≠p Y(Easting - 6 s·ªë), X(Northing - 7 s·ªë) ho·∫∑c ng∆∞·ª£c l·∫°i.
      // Th√¥ng th∆∞·ªùng ·ªü VN, X l√† Northing (7 s·ªë), Y l√† Easting (6 s·ªë).
      // Nh∆∞ng textbox ghi "VN2000: Y, X" theo th√≥i quen tr·∫Øc ƒë·ªãa hay to√°n h·ªçc?
      // Check ƒë·ªô l·ªõn ƒë·ªÉ ƒëo√°n: X (Northing) ~ 1,000,000+, Y (Easting) ~ 400,000 - 600,000 (M√∫i 3)

      let vX = parts[0];
      let vY = parts[1];

      // Auto swap if needed based on typical VN2000 ranges for Vietnam
      // Northing (X) th∆∞·ªùng > 1,000,000 (kho·∫£ng 8-23 ƒë·ªô vƒ© b·∫Øc => 1tr - 2.5tr m√©t)
      // Easting (Y) th∆∞·ªùng 500,000 +/- 150km => 350,000 - 650,000 (·ªü d·∫°ng kh·ª≠ 500k th√¨ kh√°c, nh∆∞ng d·∫°ng chu·∫©n VN2000 th∆∞·ªùng l√† s·ªë d∆∞∆°ng l·ªõn).
      // N·∫øu user nh·∫≠p ƒë√∫ng Y(Easting), X(Northing):
      let e = vX;
      let n = vY;

      // Heuristic: N·∫øu s·ªë th·ª© 1 l·ªõn h∆°n 800,000 v√† s·ªë th·ª© 2 nh·ªè h∆°n 800,000 => Kh·∫£ nƒÉng s·ªë 1 l√† Northing (X)
      if (vX > 800000 && vY < 800000) { e = vY; n = vX; }
      else if (vY > 800000 && vX < 800000) { e = vX; n = vY; }

      // Transform
      try {
        const wgs = proj4(proj4.defs('VN2000_Current'), proj4.defs('EPSG:4326'), [e, n]);
        if (isNaN(wgs[0]) || isNaN(wgs[1])) throw "NaN";

        map.flyTo([wgs[1], wgs[0]], 18);
        createSearchMarker([wgs[1], wgs[0]], `<div style='text-align:center'><b>VN2000 Found</b><br>X: ${n}<br>Y: ${e}</div>`);
      } catch (err) {
        alert("L·ªói chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô! Ki·ªÉm tra l·∫°i s·ªë li·ªáu.");
      }
    }

    function searchWGS84() {
      const val = document.getElementById('input-wgs84').value.trim();
      if (!val) return alert("Nh·∫≠p Lat, Lng!");
      let parts = val.split(/[,;\s]+/).map(Number).filter(n => !isNaN(n));
      if (parts.length < 2) return alert("C·∫ßn nh·∫≠p Latitude v√† Longitude!");

      let lat = parts[0];
      let lng = parts[1];

      // Basic check for Vietnam bounds (Lat 8-24, Lng 102-110) just to warn, but allow map to fly anywhere
      map.flyTo([lat, lng], 18);

      // Convert ng∆∞·ª£c sang VN2000 ƒë·ªÉ hi·ªÉn th·ªã info
      const vn = proj4(proj4.defs('EPSG:4326'), proj4.defs('VN2000_Current'), [lng, lat]);
      createSearchMarker([lat, lng], `<div style='text-align:center'><b>WGS84 Location</b><br>Lat: ${lat}<br>Lng: ${lng}<br>VN2000: ${vn[1].toFixed(2)}, ${vn[0].toFixed(2)}</div>`);
    }

    function locateUser() { map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true }); }
    map.on('locationfound', e => L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#0d6efd', fillOpacity: 1, weight: 3 }).addTo(map));
  </script>
</body>

</html>
