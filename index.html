<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>T√†i ƒê·ªó_Map_2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
  <style>
    :root {
      --primary-white: #ffffff;
      --bg-light: #f8f9fa;
      --border-color: #dee2e6;
      --text-main: #343a40;
      --accent-orange: #fd7e14;
      --accent-blue: #0d6efd;
      --accent-green: #198754;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      overflow: hidden;
      color: var(--text-main);
    }

    #map {
      height: 100vh;
      width: 100%;
      z-index: 1;
      background: #eee;
    }

    #top-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1000;
      background: var(--primary-white);
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"],
    input[type="text"],
    input[type="file"] {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    .file-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .file-box label {
      font-size: 10px;
      font-weight: bold;
      color: #666;
    }

    #soto,
    #sothua {
      width: 50px;
    }

    #tenchu {
      width: 100px;
    }

    .layer-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 10px;
      border-left: 1px solid #ddd;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    button {
      padding: 9px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
    }

    .btn-search {
      background: var(--accent-orange);
      color: white;
    }

    .btn-locate {
      background: var(--accent-blue);
      color: white;
    }

    .btn-clear {
      background: #e9ecef;
      color: #495057;
    }

    .btn-direction {
      background: var(--accent-green);
      color: white;
    }

    .btn-export {
      background: #6f42c1;
      color: white;
    }

    #direction-btn-container {
      display: flex;
      gap: 10px;
    }

    #info-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--primary-white);
      padding: 12px 20px;
      display: none;
      overflow-x: auto;
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.05);
    }

    .info-container {
      display: flex;
      gap: 25px;
      align-items: center;
      min-width: max-content;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 11px;
      color: #6c757d;
      font-weight: 700;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 15px;
      color: var(--text-main);
      font-weight: 700;
    }

    .edge-label-inner {
      background: var(--primary-white);
      border: 1.5px solid #dc3545;
      border-radius: 4px;
      padding: 2px 5px;
      font-size: 11px;
      font-weight: 800;
      color: #dc3545;
      white-space: nowrap;
    }

    #loading-status {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-main);
      color: white;
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 13px;
      display: none;
      z-index: 2000;
    }

    @media (max-width: 768px) {
      #top-panel {
        gap: 8px;
      }

      .layer-controls {
        border-left: none;
        border-top: 1px solid #ddd;
        padding-top: 5px;
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <div id="loading-status">üõ∞Ô∏è ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>

  <div id="top-panel">
    <div class="file-box">
      <label>ƒê·ªäA CH√çNH</label>
      <input type="file" id="file-dc" accept=".geojson">
    </div>
    <div class="file-box">
      <label>QUY HO·∫†CH</label>
      <input type="file" id="file-qh" accept=".geojson">
    </div>

    <div class="file-box">
      <label>T·ªàNH/TP</label>
      <select id="sel-province"
        style="padding: 7px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;"></select>
    </div>

    <div class="input-group">
      <input type="number" id="soto" placeholder="T·ªù">
      <input type="number" id="sothua" placeholder="Th·ª≠a">
      <input type="text" id="tenchu" placeholder="T√™n ch·ªß">
    </div>

    <div class="layer-controls">
      <label class="checkbox-group"><input type="checkbox" id="chk-dc" checked onchange="toggleLayer('dc')"> Hi·ªán
        ƒêC</label>
      <label class="checkbox-group"><input type="checkbox" id="chk-qh" checked onchange="toggleLayer('qh')"> Hi·ªán
        QH</label>
      <label class="checkbox-group"><input type="checkbox" id="chk-edges" checked onchange="updateEdges()"> Hi·ªán
        C·∫°nh</label>
    </div>

    <button class="btn-search" onclick="searchParcel()">üîç T√åM</button>
    <button class="btn-clear" onclick="clearSearch()">‚úñ</button>
    <button class="btn-locate" onclick="locateUser()">üìç V·ªä TR√ç</button>
  </div>

  <div id="info-bar">
    <div class="info-container">
      <div id="info-content" style="display: flex; gap: 20px;"></div>
      <div id="direction-btn-container"></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map', { maxZoom: 22, zoomControl: false }).setView([10.8, 106.7], 15);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
      maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(map);

    let dcLayer = null, qhLayer = null, highlightLayer = null;
    let dcData = null, currentSelectedFeature = null;
    let edgeLabelsLayer = L.layerGroup().addTo(map);

    const fieldMapping = {
      "SHBANDO": "T·ªù", "SHTHUA": "Th·ª≠a", "DIENTICH": "Di·ªán t√≠ch (m¬≤)",
      "KHLOAIDAT": "Lo·∫°i ƒë·∫•t", "TENCHU": "T√™n ch·ªß"
    };

    // X·ª≠ l√Ω n·∫°p file ƒê·ªãa Ch√≠nh
    document.getElementById('file-dc').onchange = function (e) {
      loadFile(e.target.files[0], 'dc');
    };

    // X·ª≠ l√Ω n·∫°p file Quy Ho·∫°ch
    document.getElementById('file-qh').onchange = function (e) {
      loadFile(e.target.files[0], 'qh');
    };

    function loadFile(file, type) {
      if (!file) return;
      const reader = new FileReader();
      document.getElementById('loading-status').style.display = 'block';
      reader.onload = function () {
        try {
          const json = JSON.parse(reader.result);
          if (type === 'dc') {
            dcData = json;
            renderDC(json);
          } else {
            renderQH(json);
          }
        } catch (err) { alert("L·ªói ƒë·ªçc file GeoJSON!"); }
        document.getElementById('loading-status').style.display = 'none';
      };
      reader.readAsText(file);
    }

    function renderDC(data) {
      if (dcLayer) map.removeLayer(dcLayer);
      dcLayer = L.geoJSON(data, {
        style: { color: "#ffeb3b", weight: 1.5, fillOpacity: 0.1 },
        onEachFeature: function (feature, layer) {
          layer.on('click', function (e) { processSelection(feature, layer); L.DomEvent.stopPropagation(e); });
        }
      }).addTo(map);
      map.fitBounds(dcLayer.getBounds());
      dcLayer.bringToFront(); // Lu√¥n n·∫±m tr√™n
    }

    function renderQH(data) {
      if (qhLayer) map.removeLayer(qhLayer);
      qhLayer = L.geoJSON(data, {
        style: function (feature) {
          return {
            color: "#333",
            weight: 0.5,
            fillColor: feature.properties.fill || "#000",
            fillOpacity: feature.properties["fill-opacity"] || 0.5
          };
        },
        interactive: false // ƒê·ªÉ kh√¥ng c·∫£n tr·ªü click v√†o ƒë·ªãa ch√≠nh
      }).addTo(map);
      // --- D√íNG CODE M·ªöI TH√äM V√ÄO ---
      if (qhLayer.getBounds().isValid()) {
        map.fitBounds(qhLayer.getBounds());
      }
      if (dcLayer) dcLayer.bringToFront();
    }

    function toggleLayer(type) {
      if (type === 'dc' && dcLayer) {
        document.getElementById('chk-dc').checked ? map.addLayer(dcLayer) : map.removeLayer(dcLayer);
      }
      if (type === 'qh' && qhLayer) {
        document.getElementById('chk-qh').checked ? map.addLayer(qhLayer) : map.removeLayer(qhLayer);
      }
    }

    function searchParcel() {
      const s = document.getElementById('soto').value.trim();
      const t = document.getElementById('sothua').value.trim();
      const n = document.getElementById('tenchu').value.trim().toLowerCase();
      if (!dcLayer) return alert("Vui l√≤ng n·∫°p file ƒê·ªãa ch√≠nh!");

      let foundLayer = null;
      dcLayer.eachLayer(function (layer) {
        const p = layer.feature.properties;
        const matchPT = (s && t) ? (String(p.SHBANDO) == s && String(p.SHTHUA) == t) : false;
        const matchN = n ? (String(p.TENCHU || "").toLowerCase().includes(n)) : false;
        if (matchPT || matchN) { foundLayer = layer; }
      });

      if (foundLayer) processSelection(foundLayer.feature, foundLayer);
      else alert("Kh√¥ng t√¨m th·∫•y th·ª≠a ƒë·∫•t!");
    }

    function processSelection(feature, layer) {
      currentSelectedFeature = feature;
      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, {
        style: { color: "#dc3545", weight: 4, fillColor: "#0d6efd", fillOpacity: 0.2 }
      }).addTo(map);

      const center = layer.getBounds().getCenter();
      showInfoHorizontal(feature.properties, center.lat, center.lng);
      updateEdges();
      map.fitBounds(layer.getBounds(), { padding: [100, 100] });
    }

    function updateEdges() {
      edgeLabelsLayer.clearLayers();
      if (!currentSelectedFeature || !document.getElementById('chk-edges').checked) return;

      let coords = (currentSelectedFeature.geometry.type === "Polygon") ?
        currentSelectedFeature.geometry.coordinates[0] :
        currentSelectedFeature.geometry.coordinates[0][0];

      for (let i = 0; i < coords.length - 1; i++) {
        let p1 = L.latLng(coords[i][1], coords[i][0]);
        let p2 = L.latLng(coords[i + 1][1], coords[i + 1][0]);
        let dist = p1.distanceTo(p2);
        if (dist > 0.3) {
          let mid = [(p1.lat + p2.lat) / 2, (p1.lng + p2.lng) / 2];
          let angle = Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
          let rotation = -angle;
          if (rotation > 90) rotation -= 180;
          if (rotation < -90) rotation += 180;

          L.marker(mid, {
            icon: L.divIcon({
              className: 'edge-label-container',
              html: `<div class="edge-label-inner" style="transform: rotate(${rotation}deg);">${dist.toFixed(1)}m</div>`,
              iconSize: [40, 20]
            }), interactive: false
          }).addTo(edgeLabelsLayer);
        }
      }
    }

    function showInfoHorizontal(props, lat, lng) {
      const bar = document.getElementById('info-bar'), content = document.getElementById('info-content'), btnContainer = document.getElementById('direction-btn-container');
      bar.style.display = 'block';
      let html = "";
      Object.keys(props).forEach(key => {
        let label = fieldMapping[key] || key;
        let val = props[key];
        if (key === "SHBANDO" || key === "SHTHUA") val = Math.floor(Number(val));
        else if (key === "DIENTICH") val = Number(val).toFixed(1);
        html += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val || "-"}</span></div>`;
      });
      content.innerHTML = html;
      btnContainer.innerHTML = `
        <button class="btn-direction" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">üöó CH·ªà ƒê∆Ø·ªúNG</button>
        <button class="btn-export" onclick="exportCoords()">üì• XU·∫§T T·ªåA ƒê·ªò</button>
      `;
    }

    function locateUser() {
      if (!navigator.geolocation) return alert("Kh√¥ng h·ªó tr·ª£ GPS!");
      document.getElementById('loading-status').style.display = 'block';
      map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true });
    }

    map.on('locationfound', function (e) {
      document.getElementById('loading-status').style.display = 'none';
      L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#0d6efd', fillOpacity: 1, weight: 3 }).addTo(map);
    });

    // C·∫•u h√¨nh VN2000 M·∫∑c ƒë·ªãnh (ƒê·∫Øk L·∫Øk - 108.5)
    // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi ch·ªçn T·ªânh
    let currentKTT = 108.5;

    // Danh s√°ch 63 T·ªânh Th√†nh v√† Kinh Tuy·∫øn Tr·ª•c (KTT VN2000 - M√∫i 3 ƒë·ªô)
    // Ngu·ªìn tham kh·∫£o: Th√¥ng t∆∞ 973/2001/TT-TCDC v√† d·ªØ li·ªáu tr·∫Øc ƒë·ªãa hi·ªán h√†nh
    const provinces = [
      { name: "An Giang", ktt: 104.75 }, { name: "B√† R·ªãa - V≈©ng T√†u", ktt: 107.75 },
      { name: "B·∫°c Li√™u", ktt: 105.00 }, { name: "B·∫Øc K·∫°n", ktt: 106.50 },
      { name: "B·∫Øc Giang", ktt: 107.00 }, { name: "B·∫Øc Ninh", ktt: 105.50 },
      { name: "B·∫øn Tre", ktt: 105.75 }, { name: "B√¨nh D∆∞∆°ng", ktt: 105.75 },
      { name: "B√¨nh ƒê·ªãnh", ktt: 108.25 }, { name: "B√¨nh Ph∆∞·ªõc", ktt: 106.25 },
      { name: "B√¨nh Thu·∫≠n", ktt: 108.50 }, { name: "C√† Mau", ktt: 104.50 },
      { name: "Cao B·∫±ng", ktt: 105.75 }, { name: "C·∫ßn Th∆°", ktt: 105.00 },
      { name: "ƒê√† N·∫µng", ktt: 107.75 }, { name: "ƒê·∫Øk L·∫Øk", ktt: 108.50 },
      { name: "ƒê·∫Øk N√¥ng", ktt: 108.50 }, { name: "ƒêi·ªán Bi√™n", ktt: 103.00 },
      { name: "ƒê·ªìng Nai", ktt: 107.75 }, { name: "ƒê·ªìng Th√°p", ktt: 105.00 },
      { name: "Gia Lai", ktt: 108.50 }, { name: "H√† Giang", ktt: 105.50 },
      { name: "H√† Nam", ktt: 105.00 }, { name: "H√† N·ªôi", ktt: 105.00 },
      { name: "H√† Tƒ©nh", ktt: 105.50 }, { name: "H·∫£i D∆∞∆°ng", ktt: 105.50 },
      { name: "H·∫£i Ph√≤ng", ktt: 105.75 }, { name: "H·∫≠u Giang", ktt: 105.00 },
      { name: "H√≤a B√¨nh", ktt: 106.00 }, { name: "TP. H·ªì Ch√≠ Minh", ktt: 105.75 },
      { name: "H∆∞ng Y√™n", ktt: 105.50 }, { name: "Kh√°nh H√≤a", ktt: 108.25 },
      { name: "Ki√™n Giang", ktt: 104.50 }, { name: "Kon Tum", ktt: 107.50 },
      { name: "Lai Ch√¢u", ktt: 103.00 }, { name: "L√¢m ƒê·ªìng", ktt: 107.75 },
      { name: "L·∫°ng S∆°n", ktt: 107.25 }, { name: "L√†o Cai", ktt: 104.75 },
      { name: "Long An", ktt: 105.75 }, { name: "Nam ƒê·ªãnh", ktt: 105.50 },
      { name: "Ngh·ªá An", ktt: 104.75 }, { name: "Ninh B√¨nh", ktt: 105.00 },
      { name: "Ninh Thu·∫≠n", ktt: 108.25 }, { name: "Ph√∫ Th·ªç", ktt: 104.75 },
      { name: "Ph√∫ Y√™n", ktt: 108.50 }, { name: "Qu·∫£ng B√¨nh", ktt: 106.00 },
      { name: "Qu·∫£ng Nam", ktt: 107.75 }, { name: "Qu·∫£ng Ng√£i", ktt: 108.00 },
      { name: "Qu·∫£ng Ninh", ktt: 107.75 }, { name: "Qu·∫£ng Tr·ªã", ktt: 106.25 },
      { name: "S√≥c TrƒÉng", ktt: 105.50 }, { name: "S∆°n La", ktt: 104.00 },
      { name: "T√¢y Ninh", ktt: 105.50 }, { name: "Th√°i B√¨nh", ktt: 105.50 },
      { name: "Th√°i Nguy√™n", ktt: 106.50 }, { name: "Thanh H√≥a", ktt: 105.00 },
      { name: "Th·ª´a Thi√™n Hu·∫ø", ktt: 107.00 }, { name: "Ti·ªÅn Giang", ktt: 105.75 },
      { name: "Tr√† Vinh", ktt: 105.50 }, { name: "Tuy√™n Quang", ktt: 106.00 },
      { name: "Vƒ©nh Long", ktt: 105.50 }, { name: "Vƒ©nh Ph√∫c", ktt: 105.00 },
      { name: "Y√™n B√°i", ktt: 104.75 }
    ];

    // S·∫Øp x·∫øp theo t√™n cho d·ªÖ t√¨m
    provinces.sort((a, b) => a.name.localeCompare(b.name));

    // Kh·ªüi t·∫°o Select Province
    const selProv = document.getElementById('sel-province');
    provinces.forEach(p => {
      let opt = document.createElement('option');
      opt.value = p.ktt;
      opt.text = `${p.name} (${p.ktt})`;
      if (p.name === "ƒê·∫Øk L·∫Øk") opt.selected = true;
      selProv.appendChild(opt);
    });

    selProv.onchange = function () {
      updateVN2000(parseFloat(this.value));
    };

    function updateVN2000(ktt) {
      currentKTT = ktt;
      const def = `+proj=tmerc +lat_0=0 +lon_0=${ktt} +k=0.9999 +x_0=500000 +y_0=0 +ellps=WGS84 +towgs84=-191.90441429,-39.30318279,-111.45032835,0.00928836,-0.01975479,0.00427372,0.252906278 +units=m +no_defs`;
      proj4.defs("VN2000_Current", def);
    }

    // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
    updateVN2000(currentKTT);

    map.on('click', function (e) {
      // N·∫øu ƒëang ch·ªçn th·ª≠a ƒë·∫•t th√¨ kh√¥ng hi·ªán popup t·ªça ƒë·ªô ƒë·ªÉ tr√°nh r·ªëi
      // Tuy nhi√™n y√™u c·∫ßu l√† "click v√†o b·∫£n ƒë·ªì hi·ªÉn th·ªã to·∫° ƒë·ªô", n√™n ta c·ª© hi·ªán.
      // N·∫øu mu·ªën ∆∞u ti√™n ch·ªçn th·ª≠a, ta c√≥ th·ªÉ check e.originalEvent.defaultPrevented ho·∫∑c logic kh√°c.
      // ·ªû ƒë√¢y ta c·ª© hi·ªán popup.

      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      // Convert WGS84 (EPSG:4326) -> VN2000
      const vn2000 = proj4(proj4.defs('EPSG:4326'), proj4.defs('VN2000_Current'), [lng, lat]);

      L.popup()
        .setLatLng(e.latlng)
        .setContent(`
        <div style="text-align:center; font-size:13px;">
          <strong style="color:#0d6efd">üìç T·ªåA ƒê·ªò V·ªä TR√ç</strong><br>
          <div style="margin-top:5px; text-align:left;">
            <b>WGS84:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
            <b>VN2000 (KTT ${currentKTT}):</b> X: ${vn2000[1].toFixed(2)} | Y: ${vn2000[0].toFixed(2)}
          </div>
        </div>
      `)
        .openOn(map);
    });

    function exportCoords() {
      if (!currentSelectedFeature) return alert("Ch∆∞a ch·ªçn th·ª≠a ƒë·∫•t!");

      // L·∫•y t·ªça ƒë·ªô
      let coords = (currentSelectedFeature.geometry.type === "Polygon") ?
        currentSelectedFeature.geometry.coordinates[0] :
        currentSelectedFeature.geometry.coordinates[0][0];

      // GeoJSON th∆∞·ªùng l·∫∑p l·∫°i ƒëi·ªÉm ƒë·∫ßu v√† cu·ªëi, ta b·ªè ƒëi·ªÉm cu·ªëi ƒë·ªÉ x·ª≠ l√Ω
      let pts = coords.slice(0, coords.length - 1);

      // Chuy·ªÉn sang VN2000 Current
      // Proj4 tr·∫£ v·ªÅ [Easting, Northing] (t·ª©c [Y, X] theo quy ∆∞·ªõc user)
      // User y√™u c·∫ßu: X (7 s·ªë - Northing), Y (6 s·ªë - Easting)
      let vnPts = pts.map(p => {
        let xy = proj4(proj4.defs('EPSG:4326'), proj4.defs('VN2000_Current'), [p[0], p[1]]);
        return {
          x_user: xy[1], // Northing (7 s·ªë)
          y_user: xy[0], // Easting (6 s·ªë)
          z: 0
        };
      });

      // 1. X√°c ƒë·ªãnh chi·ªÅu (Signed Area)
      // C√¥ng th·ª©c: 0.5 * sum((x2 - x1) * (y2 + y1))
      // N·∫øu k·∫øt qu·∫£ > 0: Clockwise (n·∫øu tr·ª•c Y h∆∞·ªõng l√™n nh∆∞ to√°n h·ªçc/VN2000) (L∆∞u √Ω: tr√™n m√†n h√¨nh m√°y t√≠nh Y h∆∞·ªõng xu·ªëng th√¨ ng∆∞·ª£c l·∫°i, nh∆∞ng ƒë√¢y l√† t·ªça ƒë·ªô th·ª±c ƒë·ªãa Y h∆∞·ªõng l√™n)
      let area = 0;
      for (let i = 0; i < vnPts.length; i++) {
        let j = (i + 1) % vnPts.length;
        area += (vnPts[j].x_user - vnPts[i].x_user) * (vnPts[j].y_user + vnPts[i].y_user);
      }
      // N·∫øu area < 0 => Counter Clockwise => C·∫ßn ƒë·∫£o ng∆∞·ª£c l·∫°i ƒë·ªÉ th√†nh Clockwise
      // (Th√¥ng th∆∞·ªùng t√≠nh area theo (x*y) shoelace, nh∆∞ng c√¥ng th·ª©c tr√™n c≈©ng t∆∞∆°ng ƒë∆∞∆°ng chi·ªÅu)
      // Shoelace: sum(x_i * y_i+1 - x_i+1 * y_i).
      // Let's use simple logic: GeoJSON outer ring is CCW. We want CW. So normally just reverse.
      // However, let's verify area sign.

      // Ki·ªÉm tra chi·ªÅu kim ƒë·ªìng h·ªì b·∫±ng Shoelace standard cho ch·∫Øc
      let sum = 0;
      for (let i = 0; i < vnPts.length; i++) {
        let j = (i + 1) % vnPts.length;
        sum += (vnPts[i].y_user * vnPts[j].x_user) - (vnPts[j].y_user * vnPts[i].x_user); // (x*y_next - x_next*y) logic with x=E, y=N
      }
      // V·ªõi h·ªá t·ªça ƒë·ªô Descartes (N l√™n, E ph·∫£i):
      // CW n·∫øu Sum < 0. CCW n·∫øu Sum > 0.
      // (L∆∞u √Ω: c√¥ng th·ª©c tr√™n l√† cho E, N ƒë√≥ng vai tr√≤ x,y chu·∫©n).
      // ·ªû ƒë√¢y x_user=N, y_user=E.
      // T·ªët nh·∫•t d√πng logic GeoJSON: GeoJSON outer ring lu√¥n l√† CCW.
      // User mu·ªën CW. V·∫≠y ta lu√¥n Reverse m·∫£ng g·ªëc t·ª´ GeoJSON l√† xong.

      vnPts.reverse();

      // 2. T√¨m ƒëi·ªÉm c·ª±c B·∫Øc (High X_user)
      // N·∫øu c√≥ nhi·ªÅu ƒëi·ªÉm b·∫±ng nhau, l·∫•y ƒëi·ªÉm ƒë·∫ßu ti√™n g·∫∑p (ho·∫∑c logic n√†o ƒë√≥, ·ªü ƒë√¢y taking first max)
      let maxIdx = 0;
      for (let i = 1; i < vnPts.length; i++) {
        if (vnPts[i].x_user > vnPts[maxIdx].x_user) {
          maxIdx = i;
        }
      }

      // 3. Xoay m·∫£ng ƒë·ªÉ b·∫Øt ƒë·∫ßu t·ª´ maxIdx
      let orderedPts = [...vnPts.slice(maxIdx), ...vnPts.slice(0, maxIdx)];

      // T·∫°o n·ªôi dung file
      const p = currentSelectedFeature.properties;
      let filename = `ToaDo_To_${p.SHBANDO}_Thua_${p.SHTHUA}.txt`;
      let content = "STT\tX(m)\tY(m)\tZ(m)\n";

      orderedPts.forEach((pt, idx) => {
        content += `${idx + 1}\t${pt.x_user.toFixed(3)}\t${pt.y_user.toFixed(3)}\t0.000\n`;
      });

      // Download
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function clearSearch() {
      ['soto', 'sothua', 'tenchu'].forEach(id => document.getElementById(id).value = '');
      if (highlightLayer) map.removeLayer(highlightLayer);
      edgeLabelsLayer.clearLayers();
      document.getElementById('info-bar').style.display = 'none';
      currentSelectedFeature = null;
    }
  </script>
</body>

</html>
