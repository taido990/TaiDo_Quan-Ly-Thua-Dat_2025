<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>T√†i ƒê·ªó_Qu·∫£n l√Ω Th·ª≠a ƒë·∫•t_2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; overflow: hidden; }
    #map { height: 100vh; width: 100%; z-index: 1; }
    
    #top-panel {
      position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
      background: rgba(255, 255, 255, 0.95); padding: 8px 12px;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .input-group { display: flex; align-items: center; gap: 4px; }
    input[type="number"], input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
    #soto, #sothua { width: 50px; }
    #tenchu { width: 100px; }

    .checkbox-group { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: bold; color: #2c3e50; }
    
    button {
      padding: 8px 10px; border: none; border-radius: 4px; 
      cursor: pointer; font-weight: bold; font-size: 12px;
      display: flex; align-items: center; gap: 4px;
    }
    .btn-search { background: #e67e22; color: white; }
    .btn-clear { background: #95a5a6; color: white; }
    .btn-locate { background: #3498db; color: white; }
    .btn-direction { background: #27ae60; color: white; }

    #info-bar {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
      background: #fff; padding: 10px 15px; display: none;
      overflow-x: auto; border-top: 3px solid #e67e22;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .info-container { display: flex; gap: 18px; align-items: center; min-width: max-content; }
    .info-item { display: flex; flex-direction: column; border-right: 1px solid #eee; padding-right: 15px; }
    .info-label { font-size: 10px; color: #7f8c8d; font-weight: bold; text-transform: uppercase; }
    .info-value { font-size: 14px; color: #2c3e50; font-weight: bold; white-space: nowrap; }

    /* C·∫¨P NH·∫¨T NH√ÉN C·∫†NH C√ì XOAY */
    .edge-label-container {
        background: transparent;
        border: none;
    }
    .edge-label-inner {
      background: #ffffff; 
      border: 1px solid #ff0000; 
      border-radius: 3px;
      padding: 1px 4px; 
      font-size: 11px; 
      font-weight: bold; 
      color: #ff0000;
      white-space: nowrap; 
      box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform-origin: center;
    }

    .gps-fixed { animation: pulse 2s infinite; border: 2px solid white; border-radius: 50%; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(52, 152, 219, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    #loading-status {
      position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
      background: rgba(44, 62, 80, 0.9); color: white; padding: 8px 15px;
      border-radius: 20px; font-size: 12px; display: none; z-index: 2000;
    }
  </style>
</head>
<body>

<div id="loading-status">üì° ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...</div>

<div id="top-panel">
  <input type="file" id="file-input" accept=".geojson" style="max-width: 100px; font-size: 10px;">
  <div class="input-group">
    <input type="number" id="soto" placeholder="T·ªù">
    <input type="number" id="sothua" placeholder="Th·ª≠a">
    <input type="text" id="tenchu" placeholder="T√™n ch·ªß">
  </div>
  <label class="checkbox-group">
    <input type="checkbox" id="chk-edges" checked onchange="toggleEdges()"> Hi·ªán C·∫°nh
  </label>
  <button class="btn-search" onclick="searchParcel()">üîç</button>
  <button class="btn-clear" onclick="clearSearch()">‚úñ</button>
  <button class="btn-locate" onclick="locateUser()">üìç V·ªä TR√ç</button>
</div>

<div id="info-bar">
  <div class="info-container">
    <div id="info-content" style="display: flex; gap: 15px;"></div>
    <div id="direction-btn-container"></div>
  </div>
</div>

<div id="map"></div>

<script>
  const map = L.map('map', { maxZoom: 22, zoomControl: false }).setView([10.8, 106.7], 15);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3']
  }).addTo(map);

  let dataLayer = null, highlightLayer = null, geojsonData = null, userMarker = null;
  let edgeLabelsLayer = L.layerGroup().addTo(map);
  let currentSelectedFeature = null;

  const fieldMapping = { "SHBANDO": "T·ªù", "SHTHUA": "Th·ª≠a", "DIENTICH": "DT (m2)", "KHLOAIDAT": "Lo·∫°i ƒê·∫•t", "TENCHU": "T√™n Ch·ªß" };

  document.getElementById('file-input').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function() {
      try {
        geojsonData = JSON.parse(reader.result);
        renderBoundaries(geojsonData);
      } catch(err) { alert("L·ªói ƒë·ªçc file GeoJSON!"); }
    };
    reader.readAsText(e.target.files[0]);
  };

  function renderBoundaries(data) {
    if (dataLayer) map.removeLayer(dataLayer);
    dataLayer = L.geoJSON(data, {
      style: { color: "#ffff00", weight: 1, fillOpacity: 0.05 },
      onEachFeature: function(feature, layer) {
        layer.on('click', function(e) { processSelection(feature, layer); L.DomEvent.stopPropagation(e); });
      }
    }).addTo(map);
    map.fitBounds(dataLayer.getBounds());
  }

  function searchParcel() {
    const s = document.getElementById('soto').value.trim();
    const t = document.getElementById('sothua').value.trim();
    const n = document.getElementById('tenchu').value.trim().toLowerCase();
    if (!geojsonData) return alert("Vui l√≤ng ch·ªçn file d·ªØ li·ªáu!");
    let foundFeature = null, foundLayer = null;
    dataLayer.eachLayer(function(layer) {
      const p = layer.feature.properties;
      const matchPT = (s && t) ? (String(p.SHBANDO) == s && String(p.SHTHUA) == t) : false;
      const matchN = n ? (String(p.TENCHU || "").toLowerCase().includes(n)) : false;
      if (matchPT || matchN) { foundFeature = layer.feature; foundLayer = layer; }
    });
    if (foundFeature) processSelection(foundFeature, foundLayer);
    else alert("Kh√¥ng t√¨m th·∫•y th·ª≠a ƒë·∫•t!");
  }

  function processSelection(feature, layer) {
    currentSelectedFeature = feature;
    highlightParcel([feature]);
    const center = layer.getBounds().getCenter();
    showInfoHorizontal(feature.properties, center.lat, center.lng);
    toggleEdges();
    map.fitBounds(layer.getBounds(), { padding: [100, 100] });
  }

  // --- H√ÄM HI·ªÇN TH·ªä C·∫†NH C√ì T·ª∞ ƒê·ªòNG XOAY ---
  function toggleEdges() {
    if (!currentSelectedFeature) return;
    edgeLabelsLayer.clearLayers();
    if (document.getElementById('chk-edges').checked) {
      let coords = (currentSelectedFeature.geometry.type === "Polygon") ? currentSelectedFeature.geometry.coordinates[0] : currentSelectedFeature.geometry.coordinates[0][0];
      
      for (let i = 0; i < coords.length - 1; i++) {
        let p1 = L.latLng(coords[i][1], coords[i][0]);
        let p2 = L.latLng(coords[i+1][1], coords[i+1][0]);
        let dist = p1.distanceTo(p2);
        
        if (dist > 0.5) {
          let mid = [(p1.lat + p2.lat)/2, (p1.lng + p2.lng)/2];
          
          // T√≠nh g√≥c xoay (bearing) gi·ªØa 2 ƒëi·ªÉm
          // S·ª≠ d·ª•ng c√¥ng th·ª©c atan2 tr√™n t·ªça ƒë·ªô m√†n h√¨nh x·∫•p x·ªâ
          let angle = Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
          
          // Chu·∫©n h√≥a g√≥c ƒë·ªÉ ch·ªØ lu√¥n h∆∞·ªõng l√™n tr√™n (d·ªÖ ƒë·ªçc)
          let rotation = -angle; 
          if (rotation > 90) rotation -= 180;
          if (rotation < -90) rotation += 180;

          let labelHtml = `<div class="edge-label-inner" style="transform: rotate(${rotation}deg);">${dist.toFixed(1)}m</div>`;
          
          L.marker(mid, { 
            icon: L.divIcon({ 
                className: 'edge-label-container', 
                html: labelHtml, 
                iconSize: [40, 20],
                iconAnchor: [20, 10] 
            }), 
            interactive: false 
          }).addTo(edgeLabelsLayer);
        }
      }
    }
  }

  function highlightParcel(features) {
    if (highlightLayer) map.removeLayer(highlightLayer);
    highlightLayer = L.geoJSON({type: "FeatureCollection", features: features}, {
      style: { color: "#ff0000", weight: 4.5, fillColor: "#3498db", fillOpacity: 0.2 }
    }).addTo(map);
  }

  function showInfoHorizontal(props, lat, lng) {
    const bar = document.getElementById('info-bar'), content = document.getElementById('info-content'), btnContainer = document.getElementById('direction-btn-container');
    bar.style.display = 'block';
    let html = "";
    Object.keys(props).forEach(key => {
        let label = fieldMapping[key] || key;
        let val = props[key];
        if (key === "SHBANDO" || key === "SHTHUA") val = Math.floor(Number(val));
        else if (key === "DIENTICH") val = Number(val).toFixed(1);
        else if (typeof val === 'number') val = Number.isInteger(val) ? val : val.toFixed(1);
        html += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val || "-"}</span></div>`;
    });
    content.innerHTML = html;
    btnContainer.innerHTML = `<button class="btn-direction" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">üöó CH·ªà ƒê∆Ø·ªúNG</button>`;
  }

  function locateUser() {
    if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
    document.getElementById('loading-status').style.display = 'block';
    map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true, timeout: 10000 });
  }

  map.on('locationfound', function(e) {
    document.getElementById('loading-status').style.display = 'none';
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.layerGroup([
      L.circle(e.latlng, { radius: e.accuracy / 2, color: '#3498db', fillOpacity: 0.1 }),
      L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#3498db', fillOpacity: 1, weight: 3, className: 'gps-fixed' })
    ]).addTo(map);
  });

  map.on('locationerror', function(e) {
    if (e.code === 3) {
        document.getElementById('loading-status').innerText = "üåê ƒêang th·ª≠ ƒë·ªãnh v·ªã b·∫±ng m·∫°ng...";
        map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: false, timeout: 5000 });
    } else {
        document.getElementById('loading-status').style.display = 'none';
        alert("L·ªói: " + e.message + "\nVui l√≤ng d√πng HTTPS.");
    }
  });

  function clearSearch() {
    document.getElementById('soto').value = ''; document.getElementById('sothua').value = ''; document.getElementById('tenchu').value = '';
    currentSelectedFeature = null;
    if (highlightLayer) map.removeLayer(highlightLayer);
    edgeLabelsLayer.clearLayers();
    document.getElementById('info-bar').style.display = 'none';
  }
</script>
</body>
</html>