<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>T√†i ƒê·ªó_Qu·∫£n l√Ω Th·ª≠a ƒë·∫•t & Quy ho·∫°ch_2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary-white: #ffffff;
      --bg-light: #f8f9fa;
      --border-color: #dee2e6;
      --text-main: #343a40;
      --accent-orange: #fd7e14;
      --accent-blue: #0d6efd;
      --accent-green: #198754;
    }

    body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-light); overflow: hidden; color: var(--text-main); }
    #map { height: 100vh; width: 100%; z-index: 1; background: #eee; }
    
    #top-panel {
      position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
      background: var(--primary-white); padding: 12px 15px;
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      border-radius: 8px; border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .input-group { display: flex; align-items: center; gap: 6px; }
    
    input[type="number"], input[type="text"], input[type="file"] { 
      padding: 8px 12px; border: 1px solid var(--border-color); 
      border-radius: 6px; font-size: 13px; outline: none;
    }
    
    .file-box { display: flex; flex-direction: column; gap: 2px; }
    .file-box label { font-size: 10px; font-weight: bold; color: #666; }

    #soto, #sothua { width: 50px; }
    #tenchu { width: 100px; }

    .layer-controls {
      display: flex; align-items: center; gap: 10px; 
      padding: 0 10px; border-left: 1px solid #ddd;
    }

    .checkbox-group { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }

    button {
      padding: 9px 14px; border: none; border-radius: 6px; 
      cursor: pointer; font-weight: 600; font-size: 12px;
      display: flex; align-items: center; gap: 5px; transition: 0.3s;
    }
    .btn-search { background: var(--accent-orange); color: white; }
    .btn-locate { background: var(--accent-blue); color: white; }
    .btn-clear { background: #e9ecef; color: #495057; }
    .btn-direction { background: var(--accent-green); color: white; }

    #info-bar {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
      background: var(--primary-white); padding: 12px 20px; display: none;
      overflow-x: auto; border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
    }

    .info-container { display: flex; gap: 25px; align-items: center; min-width: max-content; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-size: 11px; color: #6c757d; font-weight: 700; text-transform: uppercase; }
    .info-value { font-size: 15px; color: var(--text-main); font-weight: 700; }

    .edge-label-inner {
      background: var(--primary-white); border: 1.5px solid #dc3545; 
      border-radius: 4px; padding: 2px 5px; font-size: 11px; font-weight: 800; 
      color: #dc3545; white-space: nowrap;
    }

    #loading-status {
      position: fixed; top: 120px; left: 50%; transform: translateX(-50%);
      background: var(--text-main); color: white; padding: 10px 20px;
      border-radius: 30px; font-size: 13px; display: none; z-index: 2000;
    }

    @media (max-width: 768px) {
      #top-panel { gap: 8px; }
      .layer-controls { border-left: none; border-top: 1px solid #ddd; padding-top: 5px; width: 100%; }
    }
  </style>
</head>
<body>

<div id="loading-status">üõ∞Ô∏è ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>

<div id="top-panel">
  <div class="file-box">
    <label>ƒê·ªäA CH√çNH</label>
    <input type="file" id="file-dc" accept=".geojson">
  </div>
  <div class="file-box">
    <label>QUY HO·∫†CH</label>
    <input type="file" id="file-qh" accept=".geojson">
  </div>

  <div class="input-group">
    <input type="number" id="soto" placeholder="T·ªù">
    <input type="number" id="sothua" placeholder="Th·ª≠a">
    <input type="text" id="tenchu" placeholder="T√™n ch·ªß">
  </div>

  <div class="layer-controls">
    <label class="checkbox-group"><input type="checkbox" id="chk-dc" checked onchange="toggleLayer('dc')"> Hi·ªán ƒêC</label>
    <label class="checkbox-group"><input type="checkbox" id="chk-qh" checked onchange="toggleLayer('qh')"> Hi·ªán QH</label>
    <label class="checkbox-group"><input type="checkbox" id="chk-edges" checked onchange="updateEdges()"> Hi·ªán C·∫°nh</label>
  </div>

  <button class="btn-search" onclick="searchParcel()">üîç T√åM</button>
  <button class="btn-clear" onclick="clearSearch()">‚úñ</button>
  <button class="btn-locate" onclick="locateUser()">üìç V·ªä TR√ç</button>
</div>

<div id="info-bar">
  <div class="info-container">
    <div id="info-content" style="display: flex; gap: 20px;"></div>
    <div id="direction-btn-container"></div>
  </div>
</div>

<div id="map"></div>

<script>
  const map = L.map('map', { maxZoom: 22, zoomControl: false }).setView([10.8, 106.7], 15);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3']
  }).addTo(map);

  let dcLayer = null, qhLayer = null, highlightLayer = null;
  let dcData = null, currentSelectedFeature = null;
  let edgeLabelsLayer = L.layerGroup().addTo(map);

  const fieldMapping = { 
    "SHBANDO": "T·ªù", "SHTHUA": "Th·ª≠a", "DIENTICH": "Di·ªán t√≠ch (m¬≤)", 
    "KHLOAIDAT": "Lo·∫°i ƒë·∫•t", "TENCHU": "T√™n ch·ªß" 
  };

  // X·ª≠ l√Ω n·∫°p file ƒê·ªãa Ch√≠nh
  document.getElementById('file-dc').onchange = function(e) {
    loadFile(e.target.files[0], 'dc');
  };

  // X·ª≠ l√Ω n·∫°p file Quy Ho·∫°ch
  document.getElementById('file-qh').onchange = function(e) {
    loadFile(e.target.files[0], 'qh');
  };

  function loadFile(file, type) {
    if (!file) return;
    const reader = new FileReader();
    document.getElementById('loading-status').style.display = 'block';
    reader.onload = function() {
      try {
        const json = JSON.parse(reader.result);
        if (type === 'dc') {
          dcData = json;
          renderDC(json);
        } else {
          renderQH(json);
        }
      } catch(err) { alert("L·ªói ƒë·ªçc file GeoJSON!"); }
      document.getElementById('loading-status').style.display = 'none';
    };
    reader.readAsText(file);
  }

  function renderDC(data) {
    if (dcLayer) map.removeLayer(dcLayer);
    dcLayer = L.geoJSON(data, {
      style: { color: "#ffeb3b", weight: 1.5, fillOpacity: 0.1 },
      onEachFeature: function(feature, layer) {
        layer.on('click', function(e) { processSelection(feature, layer); L.DomEvent.stopPropagation(e); });
      }
    }).addTo(map);
    map.fitBounds(dcLayer.getBounds());
    dcLayer.bringToFront(); // Lu√¥n n·∫±m tr√™n
  }

  function renderQH(data) {
    if (qhLayer) map.removeLayer(qhLayer);
    qhLayer = L.geoJSON(data, {
      style: function(feature) {
        return {
          color: "#333",
          weight: 0.5,
          fillColor: feature.properties.fill || "#000",
          fillOpacity: feature.properties["fill-opacity"] || 0.5
        };
      },
      interactive: false // ƒê·ªÉ kh√¥ng c·∫£n tr·ªü click v√†o ƒë·ªãa ch√≠nh
    }).addTo(map);
	// --- D√íNG CODE M·ªöI TH√äM V√ÄO ---
    if (qhLayer.getBounds().isValid()) {
        map.fitBounds(qhLayer.getBounds());
    }
    if (dcLayer) dcLayer.bringToFront();
  }

  function toggleLayer(type) {
    if (type === 'dc' && dcLayer) {
      document.getElementById('chk-dc').checked ? map.addLayer(dcLayer) : map.removeLayer(dcLayer);
    }
    if (type === 'qh' && qhLayer) {
      document.getElementById('chk-qh').checked ? map.addLayer(qhLayer) : map.removeLayer(qhLayer);
    }
  }

  function searchParcel() {
    const s = document.getElementById('soto').value.trim();
    const t = document.getElementById('sothua').value.trim();
    const n = document.getElementById('tenchu').value.trim().toLowerCase();
    if (!dcLayer) return alert("Vui l√≤ng n·∫°p file ƒê·ªãa ch√≠nh!");

    let foundLayer = null;
    dcLayer.eachLayer(function(layer) {
      const p = layer.feature.properties;
      const matchPT = (s && t) ? (String(p.SHBANDO) == s && String(p.SHTHUA) == t) : false;
      const matchN = n ? (String(p.TENCHU || "").toLowerCase().includes(n)) : false;
      if (matchPT || matchN) { foundLayer = layer; }
    });

    if (foundLayer) processSelection(foundLayer.feature, foundLayer);
    else alert("Kh√¥ng t√¨m th·∫•y th·ª≠a ƒë·∫•t!");
  }

  function processSelection(feature, layer) {
    currentSelectedFeature = feature;
    if (highlightLayer) map.removeLayer(highlightLayer);
    highlightLayer = L.geoJSON(feature, {
      style: { color: "#dc3545", weight: 4, fillColor: "#0d6efd", fillOpacity: 0.2 }
    }).addTo(map);

    const center = layer.getBounds().getCenter();
    showInfoHorizontal(feature.properties, center.lat, center.lng);
    updateEdges();
    map.fitBounds(layer.getBounds(), { padding: [100, 100] });
  }

  function updateEdges() {
    edgeLabelsLayer.clearLayers();
    if (!currentSelectedFeature || !document.getElementById('chk-edges').checked) return;

    let coords = (currentSelectedFeature.geometry.type === "Polygon") ? 
                 currentSelectedFeature.geometry.coordinates[0] : 
                 currentSelectedFeature.geometry.coordinates[0][0];
    
    for (let i = 0; i < coords.length - 1; i++) {
      let p1 = L.latLng(coords[i][1], coords[i][0]);
      let p2 = L.latLng(coords[i+1][1], coords[i+1][0]);
      let dist = p1.distanceTo(p2);
      if (dist > 0.3) {
        let mid = [(p1.lat + p2.lat)/2, (p1.lng + p2.lng)/2];
        let angle = Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
        let rotation = -angle;
        if (rotation > 90) rotation -= 180;
        if (rotation < -90) rotation += 180;

        L.marker(mid, { 
          icon: L.divIcon({ 
            className: 'edge-label-container', 
            html: `<div class="edge-label-inner" style="transform: rotate(${rotation}deg);">${dist.toFixed(1)}m</div>`,
            iconSize: [40, 20] 
          }), interactive: false 
        }).addTo(edgeLabelsLayer);
      }
    }
  }

  function showInfoHorizontal(props, lat, lng) {
    const bar = document.getElementById('info-bar'), content = document.getElementById('info-content'), btnContainer = document.getElementById('direction-btn-container');
    bar.style.display = 'block';
    let html = "";
    Object.keys(props).forEach(key => {
        let label = fieldMapping[key] || key;
        let val = props[key];
        if (key === "SHBANDO" || key === "SHTHUA") val = Math.floor(Number(val));
        else if (key === "DIENTICH") val = Number(val).toFixed(1);
        html += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val || "-"}</span></div>`;
    });
    content.innerHTML = html;
    btnContainer.innerHTML = `<button class="btn-direction" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">üöó CH·ªà ƒê∆Ø·ªúNG</button>`;
  }

  function locateUser() {
    if (!navigator.geolocation) return alert("Kh√¥ng h·ªó tr·ª£ GPS!");
    document.getElementById('loading-status').style.display = 'block';
    map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true });
  }

  map.on('locationfound', function(e) {
    document.getElementById('loading-status').style.display = 'none';
    L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#0d6efd', fillOpacity: 1, weight: 3 }).addTo(map);
  });

  function clearSearch() {
    ['soto', 'sothua', 'tenchu'].forEach(id => document.getElementById(id).value = '');
    if (highlightLayer) map.removeLayer(highlightLayer);
    edgeLabelsLayer.clearLayers();
    document.getElementById('info-bar').style.display = 'none';
    currentSelectedFeature = null;
  }
</script>
</body>
</html>
